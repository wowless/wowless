load("@bazel_skylib//rules:run_binary.bzl", "run_binary")

cc_binary(
    name = "wowless",
    srcs = ["main.c"],
    features = ["fully_static_link"],
    deps = [
        ":ext",
        "@elune",
        "@lsqlite3",
        "@luaexpat",
        "@luafilesystem//:lib",
        "@lyaml",
        "@lzlib",
    ],
)

cc_library(
    name = "ext",
    srcs = ["wowless/ext.c"],
    deps = ["@elune"],
)

run_binary(
    name = "build_listfile",
    tool = "@puclua",
    args = [
        "$(location tools/listfile.lua)",
        "$(location build/listfile.lua)",
    ],
    srcs = [
        "@luafilesystem",
        "@penlight",
        "tools/listfile.lua",
        "tools/util.lua",
        "vendor/listfile/community-listfile.csv",
    ],
    env = {
        "LUA_CPATH": "$(location @luafilesystem)",
        "LUA_PATH": "?.lua;external/penlight/?.lua",
    },
    outs = ["build/listfile.lua"],
)

run_binary(
    name = "build_tactkeys",
    tool = "@puclua",
    args = [
        "$(location tools/tactkeys.lua)",
        "$(location build/tactkeys.lua)",
    ],
    srcs = [
        "@luafilesystem",
        "@penlight",
        "tools/tactkeys.lua",
        "tools/util.lua",
        "vendor/tactkeys/WoW.txt",
    ],
    env = {
        "LUA_CPATH": "$(location @luafilesystem)",
        "LUA_PATH": "?.lua;external/penlight/?.lua",
    },
    outs = ["build/tactkeys.lua"],
)
